version: 2.1

parameters:
  branch_username:
    type: string
    default: "lineage-18.1"

executors:
  build-executor:
    docker:
      - image: lineageos4microg/docker-lineage-cicd:latest
    environment:
      GIT_EMAIL: ${GIT_USER_EMAIL}
      GIT_USERNAME: ${GIT_USER_NAME}

commands:
  setup_environment:
    parameters:
      device_name:
        type: string
    steps:
      - run: echo 'export TARGET_DEVICE=<< parameters.device_name >>' >> $BASH_ENV

  configure_git:
    steps:
      - run:
          name: Configure git user
          command: |
              git config --global user.email "${GIT_EMAIL}"
              git config --global user.name "${GIT_USERNAME}"

  install_git_lfs:
    steps:
      - run:
          name: Install git-lfs
          command: |
              git lfs install

jobs:
  initial_setup:
    executor: build-executor
    steps:
      - configure_git
      - install_git_lfs

  setup:
    parameters:
      target_device:
        type: string
        default: "a7y18lte"
    executor: build-executor
    steps:
      - checkout
      - setup_environment:
          device_name: << parameters.target_device >>

  sync_repo:
    parameters:
      branch_username:
        type: string
        default: "lineage-18.1"
    executor: build-executor
    steps:
      - run: |
          mkdir -p ~/android/lineage/src
          cd ~/android/lineage/src
          git config --global user.email "youremail@example.com"
          git config --global user.name "your-username"
          repo init -u https://github.com/LineageOS/android.git -b << parameters.branch_username >> --git-lfs
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

  clone_git_repos:
    parameters:
      branch_username:
        type: string
        default: "lineage-18.1"
    executor: build-executor
    steps:
      - run: |
          git clone https://github.com/LineageOS/android_hardware_samsung hardware/samsung -b << parameters.branch_username >>
          git clone https://github.com/LineageOS/android_hardware_samsung_slsi_libbt hardware/samsung_slsi/libbt -b << parameters.branch_username >>
          git clone https://github.com/LineageOS/android_hardware_samsung_slsi_scsc_wifibt_wifi_hal hardware/samsung_slsi/scsc_wifibt/wifi_hal -b << parameters.branch_username >>
          git clone https://github.com/LineageOS/android_hardware_samsung_slsi_scsc_wifibt_wpa_supplicant_lib hardware/samsung_slsi/scsc_wifibt/wpa_supplicant_lib -b << parameters.branch_username >>
          git clone https://github.com/exynos7885-dev/android_device_samsung_exynos7885-common device/samsung/exynos7885-common -b << parameters.branch_username >>
          git clone https://github.com/exynos7885-dev/android_device_samsung_a7y18lte device/samsung/a7y18lte -b << parameters.branch_username >>
          git clone https://github.com/exynos7885-dev/android_vendor_samsung_exynos7885-common vendor/samsung/exynos7885 -b << parameters.branch_username >>
          git clone https://github.com/exynos7885-dev/android_kernel_samsung_exynos7885 kernel/samsung -b << parameters.branch_username >>

  build_lineage:
    parameters:
      target_device:
        type: string
        default: "a7y18lte"
    executor: build-executor
    steps:
      - run: |
          cd ~/android/lineage/src
          source build/envsetup.sh
          lunch lineage_<< parameters.target_device >>-userdebug
          m -j$(nproc) bacon

workflows:
  version: 2
  build-lineage:
    jobs:
      - initial_setup
      - setup:
          requires:
            - initial_setup
      - sync_repo:
          requires:
            - setup
      - clone_git_repos:
          requires:
            - sync_repo
      - build_lineage:
          requires:
            - clone_git_repos
            
