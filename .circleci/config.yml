version: 2.1

parameters:
  branch_name:
    type: string
    default: "lineage-18.1"
  git_email:
    type: string
    default: "you@example.com"
  git_username:
    type: string
    default: "Your Name"
  target_device:
    type: string
    default: "a7y18lte"

executors:
  build-executor:
    docker:
      - image: lineageos4microg/docker-lineage-cicd:latest

jobs:
  setup:
    executor: build-executor
    steps:
      - checkout
      - setup_environment:
          device_name: << parameters.target_device >>
      - configure_git:
          email: << parameters.git_email >>
          username: << parameters.git_username >>
      - install_git_lfs
      
  sync_repo:
    executor: build-executor
    steps:
      - run: |
          mkdir -p ~/android/lineage/src
          cd ~/android/lineage/src
          repo init -u https://github.com/LineageOS/android.git -b << parameters.branch_name >> --git-lfs
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

  clone_git_repos:
    executor: build-executor
    steps:
      - run: |
          git clone https://github.com/LineageOS/android_hardware_samsung hardware/samsung -b << parameters.branch >>
          git clone https://github.com/LineageOS/android_hardware_samsung_slsi_libbt hardware/samsung_slsi/libbt -b << parameters.branch >>
          git clone https://github.com/LineageOS/android_hardware_samsung_slsi_scsc_wifibt_wifi_hal hardware/samsung_slsi/scsc_wifibt/wifi_hal -b << parameters.branch >>
          git clone https://github.com/LineageOS/android_hardware_samsung_slsi_scsc_wifibt_wpa_supplicant_lib hardware/samsung_slsi/scsc_wifibt/wpa_supplicant_lib -b << parameters.branch >>
          git clone https://github.com/exynos7885-dev/android_device_samsung_exynos7885-common device/samsung/exynos7885-common -b << parameters.branch >>
          git clone https://github.com/exynos7885-dev/android_device_samsung_a7y18lte device/samsung/a7y18lte -b << parameters.branch >>
          git clone https://github.com/exynos7885-dev/android_vendor_samsung_exynos7885-common vendor/samsung/exynos7885 -b << parameters.branch >>
          git clone https://github.com/exynos7885-dev/android_kernel_samsung_exynos7885 kernel/samsung -b << parameters.branch >>

  build_lineage:
    executor: build-executor
    steps:
      - run: |
          cd ~/android/lineage/src
          source build/envsetup.sh
          lunch lineage_<< parameters.target_device >>-userdebug
          m -j$(nproc) bacon

commands:
  setup_environment:
    parameters:
      device_name:
        type: string
    steps:
      - run: echo 'export TARGET_DEVICE=<< parameters.device_name >>' >> $BASH_ENV

  configure_git:
    parameters:
      email:
        type: string
      username:
        type: string
    steps:
      - run:
          name: Configure git user
          command: |
              git config --global user.email "<< parameters.email >>"
              git config --global user.name "<< parameters.username >>"

  install_git_lfs:
    steps:
      - run:
          name: Install git-lfs
          command: |
              curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
              sudo apt-get install git-lfs
              git lfs install

workflows:
  version: 2
  build-lineage:
    jobs:
      - setup
      - sync_repo:
          requires:
            - setup
      - clone_git_repos:
          requires:
            - sync_repo
      - build_lineage:
          requires:
            - clone_git_repos
